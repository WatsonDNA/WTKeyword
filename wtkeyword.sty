%
% wtkeyword.sty
%

%%%% package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{wtkeyword}[2016/03/07 dev]
\def\wtkw@pkgname{wtkeyword}
\RequirePackage{xkeyval}

%%%% error messages
\def\wtkw@warn{\PackageWarningNoLine\wtkw@pkgname}
\def\wtkw@error{\PackageError\wtkw@pkgname}

%%%% new ifs
\newif\if@wtkw@use@shortcut@
\newif\if@wtkw@use@index@
\newif\if@wtkw@make@index@
\newif\if@wtkw@full@index@
\newif\if@wtkw@ruby@
%\newif\if@wtkw@first@

%%%% package options
\DeclareOption{shortcut}{\@wtrf@use@shortcut@true}
\DeclareOption{noshortcut}{\@wtrf@use@shortcut@false}
\DeclareOption{index}{\@wtkw@use@index@true}
\DeclareOption{noindex}{\@wtkw@use@index@false}
\ExecuteOptions{index,shortcut}
\ProcessOptions\relax

%%%% key-value settings for index families
\define@cmdkeys[wtkw]{index@sp}[wtrf@temp@]{id,opt}
\define@cmdkeys[wtkw]{index}[wtrf@temp@]{index,sup}
\define@key[wtkw]{index}{full}{\@wtkw@full@index@false\def\wtkw@temp@full{#1}}
\define@key[wtkw]{index}{noindex}[\@empty]{\@wtkw@make@index@true}

%%%% key-value settings for style family
\define@key[wtkw]{style}{kwcmd}{\wtrf@name@def{wtkw@kwcmd}##1{#1}}%
\define@key[wtkw]{style}{rubycmd}{\wtrf@name@def{wtkw@rubycmd}##1{#1}}%
\define@key[wtkw]{style}{ruby}[\@empty]{\@wtkw@ruby@true\def\wtkw@temp@ruby{#1}}

%%%% define utility commands
\def\wtkw@name@def#1{\expandafter\def\csname #1\endcsname}
\def\wtkw@name@edef#1{\expandafter\edef\csname #1\endcsname}
\def\wtkw@name@use#1{\csname #1\endcsname}
\def\wtkw@if@option@exist{\@ifnextchar[}
\def\wtkw@empty{\@empty}

%%%% define \keyword command
\def\keyword{\protect\wtkw@keyword@pre}
\def\wtrf@keyword@pre{%
  \let\wtkw@read\@empty
  \let\wtkw@index\@empty
  \@ifstar
    {\@wtkw@use@font@false\wtkw@keyword}%
    {\@wtkw@use@font@true\wtkw@keyword}}
\def\wtkw@keyword{%
  \wtkw@if@option@exist
    {\wtkw@setkeys}%
    {\wtkw@@keyword}}
\def\wtkw@setkeys[#1]{%
  \@ifnextchar"{\wtkw@@setkeys}{\wtkw@@@setkeys}#1\wtkw@nil}
\def\wtkw@@setkeys"#1"#2\wtkw@nil{%
  \setkeys[wtkw]{keyword}{read=#1#2}\wtkw@@keyword}
\def\wtkw@@@setkeys#1\wtkw@nil{%
  \setkeys[wtkw]{keyword}{#1}\wtkw@@keyword}
\def\wtkw@@keyword#1{%
  \@ifundefined{wtkw@#1@read}%
    {\@wtkw@first@true
      \expandafter\xdef\csname wtkw@#1@read\endcsname{\wtkw@read}%
      \expandafter\xdef\csname wtkw@#1@index\endcsname{\wtkw@index}}%
    {\@wtkw@first@false}%
  \expandafter\ifx\csname wtkw@#1@index\endcsname\@empty
    \expandafter\ifx\csname wtkw@#1@read\endcsname\@empty
      \index{#1}%
    \else
      \index{\csname wtkw@#1@read\endcsname @#1}%
    \fi
  \else
    \index{\csname wtkw@#1@index\endcsname}%
  \fi
  \bgroup
    \if@wtkw@use@font@
      \if@wtkw@first@\firstkeywordfont\else\keywordfont\fi
    \else
      \starkeywordfont
    \fi
    \if@wtkw@ruby@
      \ifx\wtkw@ruby\wtkw@empty
        \ruby{#1}{\csname wtkw@#1@read\endcsname}%
      \else
        \ruby{#1}{\wtkw@ruby}%
      \fi
    \else #1\fi
  \egroup\@wtkw@ruby@false}

%%%% define \defkeyword command

%%%% define \setkeywordstyle command

%%%% define shortcut
\if@wtkw@use@shortcut@
  \let\kw\keyword
  \let\setkwstyle\setkeywordstyle
  \let\defkw\defkeyword
\fi

%% EOF
