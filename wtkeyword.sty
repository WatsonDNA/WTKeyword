%
% wtkeyword.sty
%

%%%% package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{wtkeyword}[2016/03/07 dev]
\def\wtkw@pkgname{wtkeyword}
\RequirePackage{xkeyval}

%%%% error messages
\def\wtkw@warn{\PackageWarningNoLine\wtkw@pkgname}
\def\wtkw@error{\PackageError\wtkw@pkgname}

%%%% new ifs
% for package options
\newif\if@wtkw@use@shortcut@
\newif\if@wtkw@use@index@
\newif\if@wtkw@debug@\@wtkw@debug@false
% for commands
\newif\if@wtkw@save@index@\@wtkw@save@index@false
\newif\if@wtkw@no@index@\@wtkw@no@index@false
\newif\if@wtkw@full@index@\@wtkw@full@index@false
\newif\if@wtkw@ruby@\@wtkw@ruby@false
\newif\if@wtkw@first@\@wtkw@first@true
\newif\if@wtkw@phantom@

%%%% package options
\DeclareOption{shortcut}{\@wtkw@use@shortcut@true}
\DeclareOption{noshortcut}{\@wtkw@use@shortcut@false}
\DeclareOption{index}{\@wtkw@use@index@true}
\DeclareOption{noindex}{\@wtkw@use@index@false}
\DeclareOption{debug}{\@wtkw@debug@true}
\ExecuteOptions{index,shortcut}
\ProcessOptions\relax

%%%% define utility commands
\def\wtkw@name@def#1{\expandafter\def\csname #1\endcsname}
\def\wtkw@name@edef#1{\expandafter\edef\csname #1\endcsname}
\def\wtkw@name@xdef#1{\expandafter\xdef\csname #1\endcsname}
\def\wtkw@name@use#1{\csname #1\endcsname}
\def\wtkw@if@option@exist{\@ifnextchar[}
\def\wtkw@if@id@exist#1{\@ifundedined{wtkw@index@#1@id}}
\def\wtkw@@empty{\wtkw@empty}
\let\wtkw@empty\@empty
\let\wtkw@index\index

%%%% key-value settings for index families
\define@cmdkeys[wtkw]{index@sp}[wtkw@temp@]{id,opt}
\define@cmdkey[wtkw]{index}[wtkw@temp@]{index}{\@wtkw@save@index@true}
\define@cmdkey[wtkw]{index}[wtkw@temp@]{read}{\@wtkw@save@index@true}
\define@cmdkey[wtkw]{index}[wtkw@temp@]{sup}{\@wtkw@save@index@true}
\define@cmdkey[wtkw]{index}[wtkw@temp@]{see}{\@wtkw@save@index@true}
\define@cmdkey[wtkw]{index}[wtkw@temp@]{full}{\@wtkw@save@index@true\@wtkw@full@index@true}
\define@key[wtkw]{index}{noindex}[\wtkw@empty]{\@wtkw@no@index@true}

%%%% key-value settings for style family
\define@cmdkey[wtkw]{style}[wtkw@temp@]{ruby}[\wtkw@empty]{\@wtkw@ruby@true}
\define@key[wtkw]{style}{kwcmd}{\wtkw@name@def{wtkw@temp@kwcmd}##1{#1}}

%%%% key-value settings for setup family
\define@key[wtkw]{setup}{kwcmd}{\wtkw@name@def{wtkw@kwcmd}##1{#1}}
\define@key[wtkw]{setup}{kwcmd*}{\wtkw@name@def{wtkw@sub@kwcmd}##1{#1}}
\define@key[wtkw]{setup}{rubycmd}{\wtkw@name@def{wtkw@rubycmd}##1##2{#1}}
\define@key[wtkw]{setup}{indexcmd}{\wtkw@name@def{wtkw@indexcmd}##1{#1}}

%%%% write index information to aux file
\def\wtkw@index@xdef#1#2{\wtkw@name@xdef{wtkw@#2@index}{#1}}
\def\wtkw@write@aux#1{%
  \expandafter\immediate\expandafter\write\expandafter\@auxout\expandafter{\expandafter
    \expandafter\string\expandafter\wtkw@index@xdef\expandafter
      {\wtkw@name@use{wtkw@#1@index}}{#1}}}

%%%% setkeys and syntax sugar
\def\wtkw@setkeys@r#1#2{\setkeys[wtkw]{#2}{#1}}
\def\wtkw@not@syntax@sugar#1\@nil{}
\def\wtkw@syntax@sugar@@a"#1"#2\@nil{\def\wtkw@member{read=#1}}
\def\wtkw@syntax@sugar@a{\@ifnextchar"{\wtkw@syntax@sugar@@a}{\wtkw@not@syntax@sugar}}
\def\wtkw@syntax@sugar@@b|#1\@nil{\def\wtkw@member{opt=#1}}
\def\wtkw@syntax@sugar@b{\@ifnextchar|{\wtkw@syntax@sugar@@b}{\wtkw@not@syntax@sugar}}

%%%% commands for making index
\def\wtkw@shape@index{%
  %\wtkw@name@edef{wtkw@#1@index}{}
}

%%%% define main function
\def\wtkw@@keyword#1{%
  \if@wtkw@save@index@
    \wtkw@shape@index{#1}%
    \wtkw@write@aux{#1}%
  \fi
  \wtkw@if@id@exist{#1}
    {\wtkw@exe@index{#1}}
    {\wtkw@warn@undefined@id{#1}}%
  \if@wtkw@phantom\else
    \wtkw@print@keyword{#1}%
  \fi}

%%%% define \keyword command
\def\keyword{\protect\wtkw@keyword@pre}
\def\wtkw@keyword@pre{%
  \@wtkw@phantom@false
  \@ifstar
    {\@wtkw@use@font@false\wtkw@keyword@@pre}
    {\@wtkw@use@font@true\wtkw@keyword@@pre}}
\def\wtkw@keyword@@pre{%
  \wtkw@if@option@exist
    {\wtkw@keyword}%
    {\wtkw@keyword@setkeys}}
\def\wtkw@keyword@setkeys[#1]{%
  \@for\wtkw@member:=#1\do{%
    \expandafter\wtkw@syntax@sugar@a\wtkw@member\@nil
    \expandafter\wtkw@syntax@sugar@b\wtkw@member\@nil
    \expandafter\wtkw@setkeys@r\expandafter{\wtkw@member}{index@sp,index,style}}
  \wtkw@keyword}

%%%% define \phantomkeyword command
\def\phantomkeyword{\protect\wtkw@phantom@keyword@pre}
\def\wtkw@phantom@keyword@pre{%
  \@wtkw@phantom@true
  \wtkw@if@option@exist
    {\wtkw@keyword}%
    {\wtkw@phantom@keyword@setkeys}}
\def\wtkw@phantom@keyword@setkeys[#1]{%
  \@for\wtkw@member:=#1\do{%
    \expandafter\wtkw@syntax@sugar@a\wtkw@member\@nil
    \expandafter\wtkw@syntax@sugar@b\wtkw@member\@nil
    \expandafter\wtkw@setkeys@r\expandafter{\wtkw@member}{index}}
  \wtkw@keyword}

%%%% define \setkeywordstyle command

%%%% define \keywordsetup command

%%%% make shortcuts (for shortcut option)
\if@wtkw@use@shortcut@
  \let\kw\keyword
  \let\phantomkw\phantomkeyword
  \let\setkwstyle\setkeywordstyle
  \let\kwsetup\keywordsetup
\fi

%%%% warn undefined id (for debug option)
\def\wtkw@warn@undefined@id#1{%
  \if@wtkw@debug@
    \wtkw@warn{keyword id '#1' does not exist.}%
  \fi}

%% EOF
